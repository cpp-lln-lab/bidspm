(faq)=

# Frequently asked questions

## General

### How can I prevent from having SPM windows pop up all the freaking time?

Running large number of batches when the GUI of MATLAB is active can be
annoying, as SPM windows will always pop up and become active instead of running
in the background like most users would prefer to.

One easy solution is to add a `spm_my_defaults` function with the following
content in the MATLAB path, or in the directory where you are running your
scripts or command from.

```matlab
function spm_my_defaults

  global defaults

  defaults.cmdline = true;

end
```

This should be picked up by bidspm and SPM upn initialization and ensure that
SPM runs in command line mode.

### How can I run any of this from the command line?

Related to the previous question but more radical. You can run most analysis
from within your terminal without starting the MATLAB graphic interface.

For this you first need to know where is the MATLAB application. Here are the
typical location depending on your operating system (where `XXx` corresponds to
the version you use).

-   Windows: `C:\Program Files\MATLAB\R20XXx\bin\matlab.exe`
-   Mac: `/Applications/Matlab_R20XXx.app/bin/matlab`
-   Linux: `/usr/local/MATLAB/R20XXx/bin/matlab`

You can then launch from a terminal in a command line only with the following
arguments: `-nodisplay -nosplash -nodesktop`

So on Linux for example:

```bash
/usr/local/MATLAB/R2017a/bin/matlab -nodisplay -nosplash -nodesktop
```

If you are on MAc or Linux, we would recommend adding those aliases to your
`.bashrc` or wherever else you keep your aliases.

```bash
matlab=/usr/local/MATLAB/R20XXx/bin/matlab
matlabcli='/usr/local/MATLAB/R20XXx/bin/matlab -nodisplay -nosplash -nodesktop'
```

### What happens if we run same code twice? Are there timestamps on the files or are we overwriting them?

In the vast majority of cases, if you have not touched anything to your options,
you will overwrite the output.

Two exceptions that actually have time stamps and are not over-written:

-   The `matlabbatches` saved in the `jobs` folders as `.mat` and `.json` files.
-   If you have saved your options with `saveOptions`, then the output `.json`
    file is saved with a time stamp too. Most of the default `getOptions`
    templates include `saveOptions` as a last function call.

In most of other cases if you don't want to overwrite previous output, you will
have to change the output directory.

For the preprocessing workflows, in general you would have to specify a
different `opt.dir.output`.

For the statistics workflows, you have a few more options as the name of the
output folders includes information that comes from the options and / or the
BIDS stats model.

The output folder name (generated by `getFFXdir()` for the subject level and by
`getRFXdir()` for the dataset level) should include the FWHM used on the BOLD
images as well as info specified in the `Inputs` section of the BIDS stats model
JSON file (like the name of the task or the MNI space of the input images).

```bash
  $ ls demos/MoAE/outputs/derivatives/bidspm-stats/sub-01/stats

  # Folder name for a model on the auditory task in SPM's MNI space
  # on data smoothed with a 6mm kernel
  task-auditory_space-IXI549Space_FWHM-6
```

But also the GLM folder will include the `Name` of the BIDS stats model as
description (`desc`) if this `Name` is not just the name `opt.taskName`.

For example, here with the following BIDS stats model.

```bash
  $ head tests/dummyData/models/model-nback_smdl.json

  {
    "Name": "nback MVPA",     # <---- this gets appended to the folder name as description
    "BIDSModelVersion": "1.0.0",
    "Description": "for folder naming",
    "Input": {
      "task": "nback"
    }
    ...
```

And this code to set things up

```matlab
  subLabel = '02';
  opt.taskName = 'nback';
  opt.space = 'individual';

  opt.dir.stats = 'outputs/derivatives/bidspm-stats';

  ffxDir = getFFXdir(subLabel, opt);
```

Here is the expected output folder name

```matlab
  expectedOutput = fullfile(opt.dir.stats, 'sub-02', 'stats', ...
                            'task-nback_space-individual_FWHM-6_desc-nbackMVPA');
```

### How can I know that things are set up properly before I run an analysis?

If you want to set things up but not let SPM actually run the batches you can
use the option:

`opt.dryRun = true()`

This can be useful when debugging. You may still run into errors when SPM jobman
takes over and starts running the batches, but you can at least see if the
batches will be constructed without error and then inspect with the SPM GUI to
make sure everything is fine.

### What is the BIDS way to name and store (Regions of Interest) ROIs?

There is no "official" way to name ROI in BIDS, but you can apply BIDS naming
principles to name those.

The closest things to ROI naming are the `masks` for the
[BIDS derivatives](https://bids-specification.readthedocs.io/en/latest/05-derivatives/03-imaging.html#masks).

Here is an example from the :ref:`face repetition demo`::

```text
  bidspm-roi
  ├── group
  │   ├── hemi-L_space-MNI_label-V1d_desc-wang_mask.json
  │   ├── hemi-L_space-MNI_label-V1d_desc-wang_mask.nii
  │   ├── hemi-L_space-MNI_label-V1v_desc-wang_mask.json
  │   ├── hemi-L_space-MNI_label-V1v_desc-wang_mask.nii
  │   ├── hemi-R_space-MNI_label-V1d_desc-wang_mask.json
  │   ├── hemi-R_space-MNI_label-V1d_desc-wang_mask.nii
  │   ├── hemi-R_space-MNI_label-V1v_desc-wang_mask.json
  │   └── hemi-R_space-MNI_label-V1v_desc-wang_mask.nii
  └── sub-01
      └── roi
          ├── sub-01_hemi-L_space-individual_label-V1d_desc-wang_mask.nii
          ├── sub-01_hemi-L_space-individual_label-V1v_desc-wang_mask.nii
          ├── sub-01_hemi-R_space-individual_label-V1d_desc-wang_mask.nii
          └── sub-01_hemi-R_space-individual_label-V1v_desc-wang_mask.nii
```

ROIs that are defined in some MNI space are going to be the same across
subjects, so you could store a "group" folder (this is not BIDSy but is less
redundant than having a copy of the same file for each subject).

The `desc` entity (description) here is used to denotate the atlas the ROI taken
from, so if you are building yours from a localizer you might not need to use
it.

Ideally you would want to add a JSON file to add metadata about those ROIs.

You can use bids-matlab to help you create BIDS valid filenames.

```matlab
  >> name_spec.ext = '.nii';
  >> name_spec.suffix = 'mask';
  >> name_spec.entities = struct( ...
                                'hemi', 'R', ...
                                'space', 'MNI', ...
                                'label', 'V1v', ...
                                'desc', 'wang');
  >> file = bids.File(name_spec);
  >> file.filename

     hemi-R_space-MNI_label-V1v_desc-wang_mask.nii
```

### How can run my script only only certain files, like just the session `02` for example?

Currently there are 2 ways of doing this.

-   using a `bids_filter_file.json` file or its counterpart field
    `opt.bidsFilterFile`
-   using the `opt.query` option field. On the long run the plan is to use only
    the `bids_filter_file.json`, but for now both possibilities should work.

#### `bids filter file`

This is similar to the way you can "select" only certain files to preprocess
with
[fmriprep](https://fmriprep.org/en/stable/faq.html#how-do-i-select-only-certain-files-to-be-input-to-fmriprep).

You can use a `opt.bidsFilterFile` field in your options to define a typical
images "bold", "T1w" in terms of their BIDS entities. The default value is:

```matlab
struct('fmap', struct('modality', 'fmap'), ...
       'bold', struct('modality', 'func', 'suffix', 'bold'), ...
       't2w',  struct('modality', 'anat', 'suffix', 'T2w'), ...
       't1w',  struct('modality', 'anat', 'space', '', 'suffix', 'T1w'), ...
       'roi',  struct('modality', 'roi', 'suffix', 'mask'));
```

Similarly when using the BIDS app bidspm you can use the argument
`bids_filter_file` to point to a JSON file that would also define typical images
"bold", "T1w"...

The default content in this case would be:

```json
{
    "fmap": { "datatype": "fmap" },
    "bold": { "datatype": "func", "suffix": "bold" },
    "t2w": { "datatype": "anat", "suffix": "T2w" },
    "t1w": { "datatype": "anat", "space": "", "suffix": "T1w" },
    "roi": { "datatype": "roi", "suffix": "mask" }
}
```

So if you wanted to run your analysis on say run `02` and `05` of session `02`,
you would define this file like this:

```json
{
    "fmap": { "datatype": "fmap" },
    "bold": {
        "datatype": "func",
        "suffix": "bold",
        "ses": "02",
        "run": ["02", "05"]
    },
    "t2w": { "datatype": "anat", "suffix": "T2w" },
    "t1w": { "datatype": "anat", "space": "", "suffix": "T1w" },
    "roi": { "datatype": "roi", "suffix": "mask" }
}
```

#### `opt.query`

You can select a subset of your data by using the `opt.query`.

This will create a "filter" that bids-matlab will use to only "query" and
retrieve the subset of files that match the requirement of that filter

In "pure" bids-matlab it would look like:

```matlab
  BIDS = bids.layout(path_to_my_dataset)
  bids.query(BIDS, 'data', opt.query)
```

So if you wanted to run your analysis on say run `02` and `05` of session `02`,
you would define your filter like this:

```matlab
  opt.query.ses = '02'
  opt.query.run = {'02', '05'}
```

(preprocessing resampling)=

## Preprocessing

### What images are resampled during preprocessing and to what resolution?

In the spatial preprocessing workflow (`bidsSpatialPrepro`):

1. When no normalization is requested

This is the case when `opt.space = 'individual'`, functional images resolution
is not changed. This cannot be overridden.

2. During normalization to MNI

By default, functional images resolution is not changed. Override possible by
setting `opt.funcVoxelDims` to the desired resolution.

The anatomical images are resampled at 1 mm.

Tissue probability maps downsampled at resolution of functional images mostly to
help with potential with creation of tissue-based mask and also quality control
pipelines.

For several files, you can guess their resolution if they have `res` entity in
their filename:

-   `res-bold` means that the image is resampled at the resolution of the BOLD
    timeseries
-   `res-r1pt0` means that the image is resampled at a resolution of 1.00 mm
    isometric

```bash
  sub-01
  ├── anat
  │   ├── sub-01_space-individual_desc-biascor_T1w.nii                   # native res
  │   ├── sub-01_space-individual_desc-skullstripped_T1w.nii             # native res
  │   ├── sub-01_space-individual_label-brain_mask.nii                   # native res
  │   ├── sub-01_space-individual_label-CSF_probseg.nii
  │   ├── sub-01_space-individual_label-GM_probseg.nii
  │   ├── sub-01_space-individual_label-WM_probseg.nii
  │   ├── sub-01_space-individual_res-r1pt0_desc-preproc_T1w.nii         # 1.0 mm
  │   ├── sub-01_space-IXI549Space_res-bold_label-CSF_probseg.nii        # bold res
  │   ├── sub-01_space-IXI549Space_res-bold_label-GM_probseg.nii         # bold res
  │   ├── sub-01_space-IXI549Space_res-bold_label-WM_probseg.nii         # bold res
  │   └── sub-01_space-IXI549Space_res-r1pt0_T1w.nii                     # 1.0 mm
  └── func
      ├── sub-01_task-auditory_space-individual_desc-mean_bold.nii       # native res
      ├── sub-01_task-auditory_space-individual_desc-preproc_bold.nii    # native res
      ├── sub-01_task-auditory_space-individual_desc-std_bold.nii        # native res
      ├── sub-01_task-auditory_space-IXI549Space_desc-mean_bold.nii      # native res
      └── sub-01_task-auditory_space-IXI549Space_desc-preproc_bold.nii   # native res
```

See those
[slides](https://docs.google.com/presentation/d/1bAAzvXpQ_4vcSO1yqOD3Uq_d70b-uu0h9xoIx0sx3es/edit?usp=sharing)
for some pointers on how to make choices for the resolution to choose for your
analysis.

## Statistics

### How can change the name of the folder of the subject level analysis?

This can be done by changing the `Name` of the run level `Nodes`
in the BIDS stats model.

If your `Nodes.Name` is one of the "default" values:

- `"run"`
- `"run level"`
- `"run_level"`
- `"run-level"`
- ...

like in the example below

```json
  "Nodes": [
    {
      "Level": "Run",
      "Name": "run_level",
    ...
```

then {func}`src.stats.subject_level.getFFXdir.m` will set the subject level folder to be named as follow:

```text
sub-subLabel
└── task-taskLabel_space-spaceLabel_FWHM-FWHMValue
```

However if your `Nodes.Name` is not one of the "default" values, like this

```json
  "Nodes": [
    {
      "Level": "Run",
      "Name": "parametric",
    ...
```

then the subject level folder to be named as follow:

```text
sub-subLabel
└── task-taskLabel_space-spaceLabel_FWHM-FWHMValue_node-parametric
```

### How should I structure my data to run my statistical analysis?

The main thing to remember is that bidspm will read the events.tsv files from
your raw BIDS data set and will read the bold images from a `bidspm-preproc`
folder.

If your data was preprocessed with fmriprep, bidspm will first need to copy,
unzip and smooth the data into a `bidspm-preproc` folder

Here is an example of how the data is organized for the MoAE fmriprep demo and
what the `bidspm` BIDS call would look like.

```bash
├── inputs
│   ├── fmriprep                     # fmriprep preprocessed BIDS dataset
│   |   ├── dataset_description.json
│   │   └── sub-01
│   │       ├── anat
│   │       ├── figures
│   │       └── func
│   │           ├── sub-01_task-auditory_desc-confounds_timeseries.json
│   │           ├── sub-01_task-auditory_desc-confounds_timeseries.tsv
│   │           ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-brain_mask.json
│   │           ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-brain_mask.nii.gz
│   │           ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-preproc_bold.json
│   │           └── sub-01_task-auditory_space-MNI152NLin6Asym_desc-preproc_bold.nii.gz
│   └── raw                          # raw BIDS dataset
│       ├── dataset_description.json
│       ├── README
│       ├── sub-01
│       │   ├── anat
│       │   │   └── sub-01_T1w.nii
│       │   └── func
│       │       ├── sub-01_task-auditory_bold.nii
│       │       └── sub-01_task-auditory_events.tsv
│       └── task-auditory_bold.json
├── models                            # models used to run the GLM
│   ├── model-MoAEfmriprep_smdl.json
│   ├── model-MoAEindividual_smdl.json
│   └── model-MoAE_smdl.json
├── options
└── outputs
    └── derivatives
        └── bidspm-preproc          # contains either data taken from fmriprep and smoothed
            ├── dataset_description.json
            ├── README
            ├── jobs
            │   └── auditory
            │       └── sub-01
            └── sub-01
                ├── anat
                └── func
                    ├── sub-01_task-auditory_desc-confounds_timeseries.json
                    ├── sub-01_task-auditory_desc-confounds_timeseries.tsv
                    ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-brain_mask.json
                    ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-brain_mask.nii
                    ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-preproc_bold.json
                    ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-preproc_bold.nii
                    ├── sub-01_task-auditory_space-MNI152NLin6Asym_desc-smth8_bold.json
                    └── sub-01_task-auditory_space-MNI152NLin6Asym_desc-smth8_bold.nii
```

```matlab
WD = fileparts(mfilename('fullpath'));

subject_label = '01';

bids_dir = fullfile(WD, 'inputs', 'raw');
output_dir = fullfile(WD, 'outputs', 'derivatives');
preproc_dir = fullfile(output_dir, 'bidspm-preproc');

model_file = fullfile(pwd, 'models', 'model-MoAEfmriprep_smdl.json');

bidspm(bids_dir, output_dir, 'subject', ...
        'participant_label', {subject_label}, ...
        'action', 'stats', ...
        'preproc_dir', preproc_dir, ...
        'model_file', model_file, ...
        'fwhm', 8, ...
        'options', opt);
```

## Results

### How can I change which slices are shown in a montage?

> In the `bidsResults.m` I get an image with the overlay of different slices. |
> How can I change which slices are shown?

When you define your options the range of slices that are to be shown can be
changed like this (see `bidsResults` help section for more information):

```matlab
    % slices position in mm [a scalar or a vector]
    opt.results(1).montage.slices = -12:4:60;

    % slices orientation: can be 'axial' 'sagittal' or 'coronal'
    % axial is default
    opt.results(1).montage.orientation = 'axial';
```
